{% extends 'base.html' %}

{% block title %}Hist√≥rico del Clima - Sistema de Gesti√≥n de Pastoreo{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/clima.css') }}">
{% endblock %}

{% block content %}
<div class="template-container">
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="breadcrumb-custom">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
            <a href="{{ url_for('dashboard_simple.index') }}" class="text-decoration-none">
                <i class="fas fa-home me-1"></i>Dashboard
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('clima.index') }}" class="text-decoration-none">
                <i class="fas fa-cloud-sun me-1"></i>Clima
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="fas fa-history me-1"></i>Hist√≥rico
        </li>
    </ol>
</nav>

<!-- Educational Header -->
<div class="template-header educational-header">
    <div class="row align-items-center position-relative">
        <div class="col-lg-8 col-md-12">
            <h1 class="mb-3">
                <i class="fas fa-history me-3"></i>
                Archivo Hist√≥rico Clim√°tico
            </h1>
            <p class="fs-5 mb-3 opacity-90 text-responsive-wrap">
                üìä El an√°lisis hist√≥rico del clima permite identificar patrones estacionales, planificar siembras y rotaciones, y tomar decisiones basadas en tendencias clim√°ticas reales.
            </p>
            <div class="d-flex flex-wrap gap-3">
                <span class="badge bg-light text-dark px-3 py-2">
                    <i class="fas fa-chart-line me-1"></i>Tendencias estacionales
                </span>
                <span class="badge bg-light text-dark px-3 py-2">
                    <i class="fas fa-calendar-alt me-1"></i>Planificaci√≥n anual
                </span>
                <span class="badge bg-light text-dark px-3 py-2">
                    <i class="fas fa-database me-1"></i>Datos hist√≥ricos
                </span>
            </div>
        </div>
        <div class="col-lg-4 col-md-12 text-lg-end text-center mt-3 mt-lg-0">
            <div class="d-flex flex-column gap-2">
                <button type="button" class="btn btn-light btn-lg shadow-lg" onclick="guardarClimaDiario()">
                    <i class="fas fa-download me-2"></i>
                    <span>Obtener Datos Ayer</span>
                </button>
                <button type="button" class="btn btn-outline-light" onclick="mostrarGraficos()">
                    <i class="fas fa-chart-line me-2"></i>Ver Gr√°ficos
                </button>
            </div>
        </div>
    </div>
</div>

<div class="template-grid">
    <!-- Main Content -->
    <div class="col-8">
        <!-- Filter Panel -->
        <div class="filter-panel">
            <h5 class="text-primary mb-3">
                <i class="fas fa-filter me-2"></i>
                üîç Filtros de B√∫squeda
            </h5>
            <form method="GET">
                <div class="row g-3">
                    <div class="col-4">
                        <label for="fecha_inicio" class="template-form-label">Fecha Inicio</label>
                        <input type="date" class="template-form-input" id="fecha_inicio" name="fecha_inicio" 
                               value="{{ fecha_inicio or '' }}">
                    </div>
                    <div class="col-4">
                        <label for="fecha_fin" class="template-form-label">Fecha Fin</label>
                        <input type="date" class="template-form-input" id="fecha_fin" name="fecha_fin" 
                               value="{{ fecha_fin or '' }}">
                    </div>
                    <div class="col-md-4 d-flex align-items-end gap-2">
                        <button type="submit" class="template-btn template-btn-primary">
                            <i class="fas fa-search me-1"></i>Buscar
                        </button>
                        <a href="{{ url_for('clima.historico') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Limpiar
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Educational Stats -->
        {% if registros %}
        <div class="row mb-4">
            <div class="col-lg-6 col-md-6 mb-3">
                <div class="educational-metric">
                    <div class="metric-value text-primary">{{ total }}</div>
                    <div class="metric-label">Registros Hist√≥ricos</div>
                    <div class="metric-explanation">
                        Base de datos clim√°tica para an√°lisis de tendencias
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-6 mb-3">
                <div class="educational-metric">
                    <div class="metric-value text-success">{{ "%.1f"|format(registros|map(attribute='temperatura_promedio')|list|average) }}¬∞C</div>
                    <div class="metric-label">Temperatura Promedio</div>
                    <div class="metric-explanation">
                        Promedio del per√≠odo seleccionado para planificaci√≥n
                    </div>
                </div>
            </div>
        </div>

        <!-- Educational Tips -->
        <div class="educational-tip">
            <h6 class="text-primary fw-bold mb-2">üìà An√°lisis de Tendencias Clim√°ticas</h6>
            <p class="mb-2">
                {% if registros %}
                    {% set temp_promedio = registros|map(attribute='temperatura_promedio')|list|average %}
                    {% set lluvia_total = registros|map(attribute='lluvia')|list|sum %}
                    {% if temp_promedio >= 25 %}
                        üå°Ô∏è <strong>Per√≠odo c√°lido</strong> - Ideal para pastos tropicales. Lluvia total: {{ "%.1f"|format(lluvia_total) }}mm.
                    {% elif temp_promedio < 20 %}
                        ‚ùÑÔ∏è <strong>Per√≠odo fresco</strong> - Crecimiento m√°s lento. Planifica suplementaci√≥n adicional.
                    {% else %}
                        üå§Ô∏è <strong>Per√≠odo templado</strong> - Condiciones moderadas para el crecimiento.
                    {% endif %}
                {% else %}
                    Los datos hist√≥ricos te permiten identificar patrones estacionales y planificar actividades agropecuarias con mayor precisi√≥n.
                {% endif %}
            </p>
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Usa estos datos para planificar siembras, rotaciones y manejo del ganado
            </small>
        </div>
        {% endif %}

        <!-- Historical Records -->
        {% if registros %}
        <div class="template-card shadow-sm mb-4 border-0">
            <div class="template-header card-header bg-gradient-primary text-white border-0">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="template-header" class="mb-0">
                            <i class="fas fa-database me-2"></i>
                            üìã Registros Clim√°ticos Hist√≥ricos
                        </h5>
                        <small class="opacity-75">Datos meteorol√≥gicos para an√°lisis y planificaci√≥n</small>
                    </div>
                    <span class="badge bg-light text-dark">{{ registros|length }} registros</span>
                </div>
            </div>
            <div class="card-body p-3">
                {% for registro in registros %}
                <div class="historical-record">
                    <div class="row align-items-center p-3">
                        <!-- Date and Weather Icon -->
                        <div class="col-3">
                            <div class="d-flex align-items-center">
                                {% if registro.descripcion == 'Despejado' %}
                                    <i class="fas fa-sun text-warning fa-3x me-3"></i>
                                {% elif registro.descripcion == 'Nublado' %}
                                    <i class="fas fa-cloud text-secondary fa-3x me-3"></i>
                                {% elif registro.descripcion == 'Parcialmente nublado' %}
                                    <i class="fas fa-cloud-sun text-info fa-3x me-3"></i>
                                {% elif 'lluvia' in registro.descripcion.lower() %}
                                    <i class="fas fa-cloud-rain text-primary fa-3x me-3"></i>
                                {% else %}
                                    <i class="fas fa-cloud text-secondary fa-3x me-3"></i>
                                {% endif %}
                                <div>
                                    <div class="fw-bold text-primary">{{ registro.fecha.strftime('%d/%m/%Y') }}</div>
                                    <small class="text-muted">{{ registro.fecha.strftime('%A') }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Weather Condition -->
                        <div class="col-3">
                            {% if registro.descripcion == 'Despejado' %}
                                <span class="weather-condition-badge condition-sunny">
                                    <i class="fas fa-sun me-2"></i>{{ registro.descripcion }}
                                </span>
                            {% elif registro.descripcion == 'Nublado' %}
                                <span class="weather-condition-badge condition-cloudy">
                                    <i class="fas fa-cloud me-2"></i>{{ registro.descripcion }}
                                </span>
                            {% elif 'lluvia' in registro.descripcion.lower() %}
                                <span class="weather-condition-badge condition-rainy">
                                    <i class="fas fa-cloud-rain me-2"></i>{{ registro.descripcion }}
                                </span>
                            {% else %}
                                <span class="weather-condition-badge condition-partly-cloudy">
                                    <i class="fas fa-cloud-sun me-2"></i>{{ registro.descripcion }}
                                </span>
                            {% endif %}
                        </div>
                        
                        <!-- Temperature -->
                        <div class="col-3">
                            <div class="text-center">
                                <div class="fw-bold text-success mb-1">{{ registro.temperatura_promedio }}¬∞C</div>
                                <div class="temperature-range">
                                    {% set temp_pos = ((registro.temperatura_promedio - registro.temperatura_min) / (registro.temperatura_max - registro.temperatura_min) * 100) if (registro.temperatura_max - registro.temperatura_min) > 0 else 50 %}
                                    <div class="temperature-marker" style="left: {{ temp_pos }}%;"></div>
                                </div>
                                <small class="text-muted">
                                    {{ registro.temperatura_min }}¬∞ - {{ registro.temperatura_max }}¬∞
                                </small>
                            </div>
                        </div>
                        
                        <!-- Additional Data -->
                        <div class="col-3">
                            <div class="row text-center">
                                <div class="col-6">
                                    <i class="fas fa-tint text-info"></i>
                                    <div class="small fw-bold">{{ registro.humedad }}%</div>
                                    <small class="text-muted">Humedad</small>
                                </div>
                                <div class="col-6">
                                    {% if registro.lluvia > 0 %}
                                        <i class="fas fa-cloud-rain text-primary"></i>
                                        <div class="small fw-bold text-primary">{{ registro.lluvia }}mm</div>
                                        <small class="text-muted">Lluvia</small>
                                    {% else %}
                                        <i class="fas fa-sun text-warning"></i>
                                        <div class="small fw-bold text-warning">{{ registro.horas_sol }}h</div>
                                        <small class="text-muted">Sol</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <nav aria-label="Paginaci√≥n de registros clim√°ticos">
            <ul class="pagination justify-content-center">
                <li class="page-item {{ 'disabled' if page <= 1 }}">
                    <a class="page-link" href="{{ url_for('clima.historico', page=page-1, fecha_inicio=fecha_inicio, fecha_fin=fecha_fin) }}">
                        <i class="fas fa-chevron-left me-1"></i>Anterior
                    </a>
                </li>
                
                {% for page_num in range(1, total_pages + 1) %}
                    {% if page_num == page %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                    {% elif page_num <= 3 or page_num > total_pages - 3 or (page_num >= page - 1 and page_num <= page + 1) %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('clima.historico', page=page_num, fecha_inicio=fecha_inicio, fecha_fin=fecha_fin) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% elif page_num == 4 or page_num == total_pages - 3 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                <li class="page-item {{ 'disabled' if page >= total_pages }}">
                    <a class="page-link" href="{{ url_for('clima.historico', page=page+1, fecha_inicio=fecha_inicio, fecha_fin=fecha_fin) }}">
                        Siguiente<i class="fas fa-chevron-right ms-1"></i>
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
        {% else %}
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-database fa-5x text-muted opacity-50"></i>
            </div>
            <h3 class="text-muted mb-3">¬°Comienza a Recopilar Datos Clim√°ticos!</h3>
            <p class="lead text-muted mb-4 text-responsive-wrap">
                Los registros hist√≥ricos te ayudar√°n a tomar mejores decisiones agropecuarias.
            </p>
            <button type="button" class="btn btn-primary btn-lg px-5" onclick="guardarClimaDiario()">
                <i class="fas fa-download me-2"></i>Obtener Primeros Datos
            </button>
        </div>
        {% endif %}
    </div>
    
    <!-- Educational Sidebar -->
    <div class="col-4">
        <div class="help-panel-main">
            <h5 class="text-primary mb-4">
                <i class="fas fa-graduation-cap me-2"></i>
                Gu√≠a de An√°lisis Hist√≥rico
            </h5>
            
            <!-- Key concepts -->
            <div class="mb-4">
                <h6 class="text-success mb-3">üìä An√°lisis de Datos</h6>
                <div class="mb-3">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-chart-line text-primary me-2 mt-1"></i>
                        <div>
                            <strong class="d-block">Tendencias Estacionales</strong>
                            <small class="text-muted">
                                Identifica patrones anuales para planificar siembras y rotaciones
                            </small>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-calendar-alt text-info me-2 mt-1"></i>
                        <div>
                            <strong class="d-block">Ciclos Clim√°ticos</strong>
                            <small class="text-muted">
                                √âpocas secas y lluviosas para manejo del agua y pastoreo
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data interpretation -->
            <div class="mb-4">
                <h6 class="text-warning mb-3">üîç Interpretaci√≥n</h6>
                <div class="mb-2">
                    <span class="badge bg-success me-2">Temp. √ìptima</span>
                    <small>20-30¬∞C para pastos</small>
                </div>
                <div class="mb-2">
                    <span class="badge bg-info me-2">Lluvia Ideal</span>
                    <small>800-1200mm/a√±o</small>
                </div>
                <div class="mb-2">
                    <span class="badge bg-warning me-2">Humedad</span>
                    <small>50-70% √≥ptima</small>
                </div>
                <div class="mb-2">
                    <span class="badge bg-primary me-2">Heliofan√≠a</span>
                    <small>>6 horas/d√≠a</small>
                </div>
            </div>
            
            <!-- Seasonal planning -->
            <div class="mb-4">
                <h6 class="text-info mb-3">üìÖ Planificaci√≥n Estacional</h6>
                <ul class="small text-muted ps-3">
                    <li><strong>√âpoca seca:</strong> Conservar agua, suplementar forraje</li>
                    <li><strong>√âpoca lluviosa:</strong> Intensificar pastoreo, fertilizar</li>
                    <li><strong>Transici√≥n:</strong> Preparar infraestructura, planificar</li>
                    <li><strong>Eventos extremos:</strong> Planes de contingencia</li>
                </ul>
            </div>
            
            <!-- Best practices -->
            <div class="mb-4">
                <h6 class="text-success mb-3">‚úÖ Mejores Pr√°cticas</h6>
                <ul class="small text-muted ps-3">
                    <li>Registrar datos diariamente</li>
                    <li>Analizar tendencias mensuales</li>
                    <li>Comparar con a√±os anteriores</li>
                    <li>Planificar con base en patrones</li>
                    <li>Actualizar estrategias seg√∫n clima</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/modules/clima.js') }}"></script>
{% endblock %} 