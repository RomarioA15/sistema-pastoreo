{% extends "base.html" %}

{% block title %}Dashboard Integral de Productividad{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
/* Estilos para barras de progreso dinÃ¡micas */
.kpi-progress-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}
.progress-productividad { background-color: #28a745; }
.progress-eficiencia { background-color: #17a2b8; }
.progress-calidad { background-color: #ffc107; }
.progress-utilizacion { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="template-container">
    <!-- Header educativo avanzado -->
    <div class="template-header dashboard-header">
        <div class="particles">
            <div class="particle" style="left: 10%; animation-delay: 0s; width: min(4px, 100%); height: 4px;"></div>
            <div class="particle" style="left: 20%; animation-delay: 1s; width: min(6px, 100%); height: 6px;"></div>
            <div class="particle" style="left: 30%; animation-delay: 2s; width: min(3px, 100%); height: 3px;"></div>
            <div class="particle" style="left: 40%; animation-delay: 3s; width: min(5px, 100%); height: 5px;"></div>
            <div class="particle" style="left: 50%; animation-delay: 4s; width: min(4px, 100%); height: 4px;"></div>
            <div class="particle" style="left: 60%; animation-delay: 1.5s; width: min(7px, 100%); height: 7px;"></div>
            <div class="particle" style="left: 70%; animation-delay: 2.5s; width: min(3px, 100%); height: 3px;"></div>
            <div class="particle" style="left: 80%; animation-delay: 3.5s; width: min(5px, 100%); height: 5px;"></div>
            <div class="particle" style="left: 90%; animation-delay: 0.5s; width: min(4px, 100%); height: 4px;"></div>
        </div>
        
        <div class="template-container">
            <div class="row align-items-center">
                <div class="col-8">
                    <h1 class="dashboard-title">ğŸ“Š Dashboard Integral de Productividad</h1>
                    <p class="dashboard-subtitle text-responsive-wrap">
                        Centro de anÃ¡lisis inteligente para monitorear el rendimiento integral de la finca
                    </p>
                    <div class="dashboard-badges">
                        <span class="dashboard-badge">ğŸŒ± AnÃ¡lisis en Tiempo Real</span>
                        <span class="dashboard-badge">ğŸ“ˆ MÃ©tricas Consolidadas</span>
                        <span class="dashboard-badge">ğŸ¯ Insights Inteligentes</span>
                        <span class="dashboard-badge">âš¡ OptimizaciÃ³n Continua</span>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-none d-md-block">
                        <i class="fas fa-chart-line" style="font-size: 4rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Breadcrumb navigation -->
    <div class="breadcrumb-nav">
        <nav class="template-breadcrumb" aria-label="breadcrumb">
            <ol class="template-breadcrumb">
                <li class="breadcrumb-item"><a href="/" style="color: #667eea;">ğŸ  Inicio</a></li>
                <li class="breadcrumb-item active" aria-current="page">Dashboard Integral</li>
            </ol>
        </nav>
    </div>

    <!-- Panel de filtros inteligentes -->
    <div class="filtros-panel">
        <h5 class="filtros-title">
            <i class="fas fa-filter"></i>
            Filtros Inteligentes de AnÃ¡lisis
        </h5>
        <div class="template-grid">
            <div class="col-6">
                <label for="filtro-potrero" class="template-form-label">
                    ğŸŒ¾ Potrero EspecÃ­fico
                </label>
                <select class="template-form-input" id="filtro-potrero">
                    <option value="">ğŸ“Š Todos los Potreros (Vista Consolidada)</option>
                    {% for potrero in potreros %}
                    <option value="{{ potrero.id }}">{{ potrero.nombre }} ({{ potrero.hectareas }} ha)</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-6">
                <label for="filtro-periodo" class="template-form-label">
                    ğŸ“… PerÃ­odo de AnÃ¡lisis
                </label>
                <select class="template-form-input" id="filtro-periodo">
                    <option value="30">ğŸ“ˆ Ãšltimos 30 dÃ­as (Tendencia Actual)</option>
                    <option value="60">ğŸ“Š Ãšltimos 60 dÃ­as (AnÃ¡lisis Bimestral)</option>
                    <option value="90" selected>ğŸ” Ãšltimos 90 dÃ­as (Vista Trimestral)</option>
                    <option value="180">ğŸ“‹ Ãšltimos 6 meses (AnÃ¡lisis Estacional)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="template-grid">
        <div class="col-9">
            <!-- KPIs consolidados -->
            <div class="kpis-grid">
                <div class="kpi-card productividad">
                    <div class="kpi-icon">ğŸŒ±</div>
                    <div class="kpi-value" id="productividad-value">{{ stats.promedio_ms or 0 }}</div>
                    <div class="kpi-label">Productividad General (kg MS/ha)</div>
                    <div class="kpi-progress">
                        <div class="kpi-progress-bar progress-productividad" data-width="{{ ((stats.promedio_ms or 0) / 3000 * 100) | round }}"></div>
                    </div>
                    <div class="kpi-range">Rango Ã³ptimo: 2,500 - 3,500 kg MS/ha</div>
                </div>

                <div class="kpi-card eficiencia">
                    <div class="kpi-icon">ğŸ”„</div>
                    <div class="kpi-value" id="eficiencia-value">{{ stats.promedio_rotacion or 0 }}</div>
                    <div class="kpi-label">Eficiencia de RotaciÃ³n (dÃ­as)</div>
                    <div class="kpi-progress">
                        <div class="kpi-progress-bar progress-eficiencia" data-width="{{ (((35 - (stats.promedio_rotacion or 0)) / 35) * 100) | round }}"></div>
                    </div>
                    <div class="kpi-range">Rango Ã³ptimo: 21 - 35 dÃ­as</div>
                </div>

                <div class="kpi-card calidad">
                    <div class="kpi-icon">â­</div>
                    <div class="kpi-value" id="calidad-value">{{ stats.altura_promedio_30d or 0 }}</div>
                    <div class="kpi-label">Calidad del Forraje (cm altura)</div>
                    <div class="kpi-progress">
                        <div class="kpi-progress-bar progress-calidad" data-width="{{ (((stats.altura_promedio_30d or 0) / 25) * 100) | round }}"></div>
                    </div>
                    <div class="kpi-range">Rango Ã³ptimo: 15 - 25 cm</div>
                </div>

                <div class="kpi-card utilizacion">
                    <div class="kpi-icon">ğŸ“Š</div>
                    <div class="kpi-value" id="utilizacion-value">{{ stats.cobertura_30d or 0 }}</div>
                    <div class="kpi-label">UtilizaciÃ³n de Pasturas (%)</div>
                    <div class="kpi-progress">
                        <div class="kpi-progress-bar progress-utilizacion" data-width="{{ stats.cobertura_30d or 0 }}"></div>
                    </div>
                    <div class="kpi-range">Rango Ã³ptimo: 65 - 85%</div>
                </div>
            </div>

            <!-- MÃ©tricas educativas -->
            <div class="metricas-grid">
                <div class="metrica-card">
                    <div class="metrica-value">{{ stats.promedio_rotacion or 0 }}</div>
                    <div class="metrica-label">DÃ­as de RotaciÃ³n Promedio</div>
                    <div class="metrica-explanation">
                        {% if (stats.promedio_rotacion or 0) <= 35 %}
                        âœ… RotaciÃ³n dentro del rango Ã³ptimo
                        {% else %}
                        âš ï¸ Considerar acelerar rotaciones
                        {% endif %}
                    </div>
                </div>

                <div class="metrica-card">
                    <div class="metrica-value">{{ stats.promedio_mv or 0 }}</div>
                    <div class="metrica-label">Materia Verde (kg/ha)</div>
                    <div class="metrica-explanation">
                        {% if (stats.promedio_mv or 0) >= 8000 %}
                        âœ… Excelente disponibilidad forrajera
                        {% else %}
                        ğŸ“ˆ Potencial de mejora disponible
                        {% endif %}
                    </div>
                </div>

                <div class="metrica-card">
                    <div class="metrica-value">{{ stats.promedio_ms or 0 }}</div>
                    <div class="metrica-label">Materia Seca (kg/ha)</div>
                    <div class="metrica-explanation">
                        {% if (stats.promedio_ms or 0) >= 2500 %}
                        âœ… Biomasa suficiente para pastoreo
                        {% else %}
                        âš ï¸ Requiere perÃ­odo de descanso
                        {% endif %}
                    </div>
                </div>

                <div class="metrica-card">
                    <div class="metrica-value">{{ stats.temp_promedio_30d or 0 }}Â°C</div>
                    <div class="metrica-label">Temperatura Promedio (30d)</div>
                    <div class="metrica-explanation">
                        {% if 20 <= (stats.temp_promedio_30d or 0) <= 30 %}
                        âœ… Condiciones Ã³ptimas para crecimiento
                        {% else %}
                        ğŸŒ¡ï¸ Monitorear estrÃ©s tÃ©rmico
                        {% endif %}
                    </div>
                </div>

                <div class="metrica-card">
                    <div class="metrica-value">{{ stats.lluvia_30d or 0 }}mm</div>
                    <div class="metrica-label">PrecipitaciÃ³n (30d)</div>
                    <div class="metrica-explanation">
                        {% if (stats.lluvia_30d or 0) >= 100 %}
                        âœ… Humedad adecuada del suelo
                        {% else %}
                        ğŸ’§ Considerar riego suplementario
                        {% endif %}
                    </div>
                </div>

                <div class="metrica-card">
                    <div class="metrica-value">{{ stats.ph_promedio_6m or 0 }}</div>
                    <div class="metrica-label">pH Promedio del Suelo</div>
                    <div class="metrica-explanation">
                        {% if 5.5 <= (stats.ph_promedio_6m or 0) <= 7.0 %}
                        âœ… pH en rango Ã³ptimo
                        {% else %}
                        ğŸ§ª Considerar enmiendas
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- SecciÃ³n de grÃ¡ficos -->
            <div class="graficos-section">
                <h4 class="mb-4">ğŸ“ˆ AnÃ¡lisis GrÃ¡fico Integral</h4>
                
                <div class="graficos-grid">
                    <!-- GrÃ¡fico de evoluciÃ³n temporal -->
                    <div class="grafico-card">
                        <h5 class="grafico-title">
                            <i class="fas fa-chart-line"></i>
                            EvoluciÃ³n Temporal de Biomasa
                        </h5>
                        <div class="chart-responsive">
                            <canvas id="evolucionChart"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #28a745;"></div>
                                <span>Materia Verde</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ffc107;"></div>
                                <span>Materia Seca</span>
                            </div>
                        </div>
                    </div>

                    <!-- GrÃ¡fico de precipitaciÃ³n vs crecimiento -->
                    <div class="grafico-card">
                        <h5 class="grafico-title">
                            <i class="fas fa-cloud-rain"></i>
                            PrecipitaciÃ³n vs Crecimiento
                        </h5>
                        <div class="chart-responsive">
                            <canvas id="precipitacionChart"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #17a2b8;"></div>
                                <span>PrecipitaciÃ³n (mm)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #28a745;"></div>
                                <span>Tasa Crecimiento</span>
                            </div>
                        </div>
                    </div>

                    <!-- Ranking de potreros -->
                    <div class="grafico-card">
                        <h5 class="grafico-title">
                            <i class="fas fa-trophy"></i>
                            Ranking de Productividad
                        </h5>
                        <div class="chart-responsive">
                            <canvas id="rankingChart"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #667eea;"></div>
                                <span>Score de Productividad</span>
                            </div>
                        </div>
                    </div>

                    <!-- GrÃ¡fico de actividades -->
                    <div class="grafico-card">
                        <h5 class="grafico-title">
                            <i class="fas fa-tasks"></i>
                            Estado de Actividades
                        </h5>
                        <div class="chart-responsive">
                            <canvas id="actividadesChart"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #28a745;"></div>
                                <span>Completadas</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ffc107;"></div>
                                <span>En Progreso</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #dc3545;"></div>
                                <span>Pendientes</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-3">
            <!-- Panel de guÃ­a educativa -->
            <div class="guia-panel">
                <h5 class="guia-title">
                    <i class="fas fa-lightbulb"></i>
                    GuÃ­a Educativa
                </h5>

                <!-- Insights inteligentes rotatorios -->
                <div class="insights-rotator">
                    <p class="insight-text text-responsive-wrap" id="insight-text">
                        ğŸ’¡ El dashboard muestra mÃ©tricas reales calculadas desde tu base de datos para tomar decisiones informadas.
                    </p>
                </div>

                <!-- Indicadores de Rendimiento -->
                <div class="guia-section">
                    <h6>ğŸ“Š Indicadores de Rendimiento</h6>
                    <ul class="guia-list">
                        <li>ğŸŒ± Productividad: Biomasa disponible por hectÃ¡rea</li>
                        <li>ğŸ”„ RotaciÃ³n: DÃ­as entre movimientos de ganado</li>
                        <li>â­ Calidad: Altura y cobertura del forraje</li>
                        <li>ğŸ“ˆ UtilizaciÃ³n: Eficiencia del aprovechamiento</li>
                        <li>ğŸŒ¡ï¸ Clima: Condiciones ambientales favorables</li>
                    </ul>
                </div>

                <!-- Estados de Potreros -->
                <div class="guia-section">
                    <h6>ğŸŒ¾ Estados de Potreros</h6>
                    <ul class="guia-list">
                        <li>âœ… Ã“ptimo: >2,500 kg MS/ha, rotaciÃ³n 21-35 dÃ­as</li>
                        <li>ğŸŸ¡ Bueno: >2,000 kg MS/ha, requiere seguimiento</li>
                        <li>ğŸŸ  Regular: 1,500-2,000 kg MS/ha, atenciÃ³n necesaria</li>
                        <li>ğŸ”´ CrÃ­tico: <1,500 kg MS/ha, descanso requerido</li>
                    </ul>
                </div>

                <!-- Acciones RÃ¡pidas -->
                <div class="guia-section">
                    <h6>âš¡ Acciones RÃ¡pidas</h6>
                    <div class="acciones-rapidas">
                        <a href="/aforos/nuevo" class="accion-btn">ğŸ“Š Nuevo Aforo</a>
                        <a href="/recorridos/nuevo" class="accion-btn">ğŸš¶ Nuevo Recorrido</a>
                        <a href="/actividades/nueva" class="accion-btn">ğŸ“‹ Nueva Actividad</a>
                        <a href="/clima" class="accion-btn">ğŸŒ¤ï¸ Ver Clima</a>
                    </div>
                </div>

                <!-- EstadÃ­sticas RÃ¡pidas -->
                <div class="guia-section">
                    <h6>ğŸ“ˆ Vista RÃ¡pida</h6>
                    <ul class="guia-list">
                        <li>ğŸï¸ Total Potreros: {{ stats.total_potreros or 0 }}</li>
                        <li>ğŸ“ Total HectÃ¡reas: {{ stats.total_hectareas or 0 }} ha</li>
                        <li>ğŸ“Š Con Aforos: {{ stats.potreros_con_aforo or 0 }}</li>
                        <li>ğŸ„ Lotes Activos: {{ stats.total_lotes or 0 }}</li>
                        <li>ğŸŒ¡ï¸ Registros Clima: {{ stats.registros_clima_30d or 0 }}</li>
                        <li>ğŸ“‹ Actividades: {{ stats.total_actividades or 0 }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alertas y notificaciones -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="alertToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="template-header toast-header">
            <i class="fas fa-info-circle me-2"></i>
            <strong class="me-auto">Dashboard</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Dashboard actualizado con datos en tiempo real
        </div>
    </div>
</div>

<script>
// Inicializar barras de progreso dinÃ¡micas
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('.kpi-progress-bar[data-width]');
    progressBars.forEach(bar => {
        const width = Math.min(Math.max(parseInt(bar.dataset.width) || 0, 0), 100);
        setTimeout(() => {
            bar.style.width = width + '%';
        }, 300);
    });
});
</script>
{% endblock %}

{% block extra_js %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/modules/dashboard.js') }}"></script>
{% endblock %}
