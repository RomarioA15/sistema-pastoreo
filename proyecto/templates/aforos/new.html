{% extends 'base.html' %}

{% block title %}Nuevo Aforo - Sistema de Gestión de Pastoreo{% endblock %}
{% block extra_css %}
<!-- CSS específico cargado automáticamente en base.html -->
<style>
/* Ajustes específicos para el formulario de nuevo aforo */
.template-container {
    max-width: 1200px;
    margin: 0 auto;
}

.muestra-item {
    background: white;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
}

.muestra-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.peso-verde:focus, .peso-seco:focus {
    border-color: var(--grass-green);
    box-shadow: 0 0 0 0.2rem rgba(124, 179, 66, 0.25);
}

#resumenCard {
    border-left: 4px solid var(--info-color);
}
</style>
{% endblock %}

{% block content %}
<div class="template-container">

<!-- HEURÍSTICA 1: Visibilidad del Estado del Sistema -->
<!-- Breadcrumb para mostrar contexto -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard_simple.index') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('aforos.index') }}">Aforos</a></li>
        <li class="breadcrumb-item active" aria-current="page">Nuevo Aforo</li>
    </ol>
</nav>

<!-- Simplified Header -->
<div class="template-header">
    <div class="template-header-content">
        <div class="template-header-text">
            <h1>
                <i class="fas fa-plus-circle text-success"></i>
                Nuevo Aforo
            </h1>
            <p>Complete la información básica para comenzar el registro</p>
        </div>
        <div class="template-header-actions">
            <a href="{{ url_for('aforos.index') }}" class="template-btn template-btn-outline">
                <i class="fas fa-times"></i>
                <span>Cancelar</span>
            </a>
        </div>
    </div>
</div>

<!-- Single Page Form Progress -->
<div class="mb-4">
    <div class="alert alert-info border-0">
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle text-info me-3 fs-4"></i>
            <div>
                <h6 class="mb-1">Formulario Completo de Aforo</h6>
                <small>Complete toda la información del aforo y sus muestras en una sola página</small>
            </div>
        </div>
    </div>
</div>

<!-- Responsive Layout -->
<div class="row g-4">
    <!-- Main Form Column -->
    <div class="col-xl-8 col-lg-7 mb-4">
        <!-- Formulario con validación en tiempo real y control de errores -->
        <form method="POST" action="{{ url_for('aforos.nuevo') }}" id="aforoForm" novalidate>
    
    <!-- Main Form Card -->
    <div class="template-card mb-4">
        <div class="template-card-body">
            <!-- Form Fields Row -->
            <div class="row g-4">
                <!-- Potrero Selection -->
                <div class="col-md-8">
                    <label for="potrero_id" class="form-label fw-semibold mb-2">
                        <i class="fas fa-map-marker-alt text-primary me-2"></i>
                        Potrero para el aforo
                        <span class="text-danger">*</span>
                    </label>
                    <select class="form-select form-select-lg" 
                            id="potrero_id" 
                            name="potrero_id" 
                            required>
                        <option value="" selected disabled>Seleccione un potrero...</option>
                        {% for potrero in potreros %}
                            <option value="{{ potrero.id }}" 
                                    data-hectareas="{{ potrero.hectareas }}"
                                    {% if request.form.get('potrero_id')|int == potrero.id %}selected{% endif %}>
                                {{ potrero.nombre }} ({{ potrero.hectareas }} ha)
                            </option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">
                        Seleccione el potrero donde realizará el aforo
                    </div>
                </div>

                <!-- Date Selection -->
                <div class="col-md-4">
                    <label for="fecha" class="form-label fw-semibold mb-2">
                        <i class="fas fa-calendar-alt text-primary me-2"></i>
                        Fecha del aforo
                        <span class="text-danger">*</span>
                    </label>
                    <input type="date" 
                           class="form-control form-control-lg" 
                           id="fecha" 
                           name="fecha" 
                           value="{{ request.form.get('fecha', '') }}" 
                           required>
                    <div class="invalid-feedback">
                        Seleccione la fecha del aforo
                    </div>
                </div>
            </div>

            <!-- Potrero info display -->
            <div id="potreroInfo" class="mt-3" style="display: none;">
                <div class="alert alert-light border-start border-info border-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        <span id="potreroDetails"></span>
                    </div>
                </div>
            </div>
            <!-- Observations Section -->
            <div class="mt-4">
                <label for="observaciones" class="form-label fw-semibold mb-2">
                    <i class="fas fa-sticky-note text-success me-2"></i>
                    Observaciones
                    <span class="text-muted fw-normal">(opcional)</span>
                </label>
                <textarea class="form-control" 
                          id="observaciones" 
                          name="observaciones" 
                          rows="3" 
                          placeholder="Estado del pasto, condiciones del suelo, humedad...">{{ request.form.get('observaciones', '') }}</textarea>
            </div>

        </div>
    </div>

    <!-- Muestras Section -->
    <div class="template-card mb-4">
        <div class="template-card-header">
            <h5>
                <i class="fas fa-flask text-success"></i>
                Muestras de Pesaje
            </h5>
            <small class="text-muted">Agregue las muestras tomadas en el potrero</small>
        </div>
        <div class="template-card-body">
            <!-- Muestras Container -->
            <div id="muestrasContainer">
                <!-- Sample template -->
                <div class="muestra-item border rounded p-3 mb-3" data-muestra="1">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-vial text-primary me-2"></i>
                            Muestra #<span class="muestra-numero">1</span>
                        </h6>
                        <button type="button" class="btn btn-outline-danger btn-sm remove-muestra" style="display: none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="row g-3">
                        <!-- Área de la muestra -->
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-square text-info me-1"></i>
                                Área (m²)
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   name="muestras[0][area_m2]"
                                   value="1"
                                   step="0.01"
                                   min="0.01"
                                   required>
                            <div class="form-text">Normalmente 1 m²</div>
                        </div>
                        
                        <!-- Peso Verde -->
                        <div class="col-md-3">
                            <label class="form-label fw-semibold required">
                                <i class="fas fa-leaf text-success me-1"></i>
                                Peso Verde (g)
                                <span class="text-danger">*</span>
                            </label>
                            <input type="number" 
                                   class="form-control peso-verde" 
                                   name="muestras[0][peso_verde_g]"
                                   step="0.1"
                                   min="0"
                                   required>
                            <div class="invalid-feedback">
                                Ingrese el peso verde
                            </div>
                        </div>
                        
                        <!-- Peso Seco -->
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-weight text-warning me-1"></i>
                                Peso Seco (g)
                            </label>
                            <input type="number" 
                                   class="form-control peso-seco" 
                                   name="muestras[0][peso_seco_g]"
                                   step="0.1"
                                   min="0">
                            <div class="form-text">Opcional - después del secado</div>
                        </div>
                        
                        <!-- Cálculos automáticos -->
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-calculator text-primary me-1"></i>
                                kg/ha MV
                            </label>
                            <input type="text" 
                                   class="form-control bg-light resultado-kgha" 
                                   readonly>
                            <div class="form-text">Calculado automáticamente</div>
                        </div>
                    </div>
                    
                    <!-- Resultados adicionales -->
                    <div class="row g-3 mt-2" style="display: none;" data-resultados>
                        <div class="col-md-4">
                            <div class="bg-light rounded p-2 text-center">
                                <small class="text-muted">kg/ha MS</small>
                                <div class="fw-bold resultado-ms">-</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-light rounded p-2 text-center">
                                <small class="text-muted">% MS</small>
                                <div class="fw-bold resultado-porcentaje">-</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-light rounded p-2 text-center">
                                <small class="text-muted">Calidad</small>
                                <div class="fw-bold resultado-calidad">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Add Sample Button -->
            <div class="text-center mt-3">
                <button type="button" class="btn btn-outline-success" id="addMuestra">
                    <i class="fas fa-plus me-2"></i>
                    Agregar Otra Muestra
                </button>
                <small class="d-block text-muted mt-2">
                    Se recomienda tomar al menos 3-5 muestras por potrero
                </small>
            </div>
        </div>
    </div>

    <!-- Resumen Automático -->
    <div class="template-card mb-4" id="resumenCard" style="display: none;">
        <div class="template-card-header">
            <h5>
                <i class="fas fa-chart-line text-info"></i>
                Resumen del Aforo
            </h5>
        </div>
        <div class="template-card-body">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="bg-success bg-opacity-10 rounded p-3">
                        <i class="fas fa-leaf text-success fs-4 mb-2"></i>
                        <div class="fw-bold fs-4" id="promedio-mv">0</div>
                        <small class="text-muted">kg/ha MV promedio</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="bg-primary bg-opacity-10 rounded p-3">
                        <i class="fas fa-weight text-primary fs-4 mb-2"></i>
                        <div class="fw-bold fs-4" id="promedio-ms">0</div>
                        <small class="text-muted">kg/ha MS promedio</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="bg-warning bg-opacity-10 rounded p-3">
                        <i class="fas fa-percentage text-warning fs-4 mb-2"></i>
                        <div class="fw-bold fs-4" id="promedio-porcentaje">0%</div>
                        <small class="text-muted">% MS promedio</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="bg-info bg-opacity-10 rounded p-3">
                        <i class="fas fa-star text-info fs-4 mb-2"></i>
                        <div class="fw-bold fs-4" id="calidad-general">-</div>
                        <small class="text-muted">Calidad general</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden fields -->
    <input type="hidden" name="action" value="create_complete">

    <!-- Action Buttons -->
    <div class="template-card">
        <div class="template-card-body">
            <div class="d-flex justify-content-between align-items-center">
                <a href="{{ url_for('aforos.index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Volver
                </a>
                <button type="submit" class="btn btn-success btn-lg px-4" id="submitBtn">
                    <i class="fas fa-save me-2"></i>
                    Guardar Aforo Completo
                </button>
            </div>
        </div>
    </div>
</form>

        <!-- Espacio reservado para mensajes de error -->
        <div id="errorMessages" style="display: none;"></div>
    </div>
    
    <!-- Help Panel Column -->
    <div class="col-xl-4 col-lg-5">
        <div class="sticky-top" style="top: 20px;">
            {% include 'aforos/_help_panel.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/modules/aforos.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form elements
    const form = document.getElementById('aforoForm');
    const potreroSelect = document.getElementById('potrero_id');
    const potreroInfo = document.getElementById('potreroInfo');
    const potreroDetails = document.getElementById('potreroDetails');
    const submitBtn = document.getElementById('submitBtn');
    const fechaInput = document.getElementById('fecha');
    const muestrasContainer = document.getElementById('muestrasContainer');
    const addMuestraBtn = document.getElementById('addMuestra');
    const resumenCard = document.getElementById('resumenCard');
    
    let muestraCount = 1;
    
    // Set today's date as default
    if (!fechaInput.value) {
        const today = new Date().toISOString().split('T')[0];
        fechaInput.value = today;
    }
    
    // Potrero selection handler
    potreroSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        
        if (selectedOption.value) {
            const hectareas = selectedOption.dataset.hectareas;
            const nombre = selectedOption.text.split(' (')[0];
            
            potreroDetails.innerHTML = `<strong>${nombre}</strong> - ${hectareas} hectáreas`;
            potreroInfo.style.display = 'block';
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            potreroInfo.style.display = 'none';
            this.classList.remove('is-valid');
        }
    });
    
    // Add new sample
    addMuestraBtn.addEventListener('click', function() {
        muestraCount++;
        const template = createMuestraTemplate(muestraCount);
        muestrasContainer.insertAdjacentHTML('beforeend', template);
        updateRemoveButtons();
        attachMuestraEvents();
    });
    
    // Create muestra template
    function createMuestraTemplate(numero) {
        return `
            <div class="muestra-item border rounded p-3 mb-3" data-muestra="${numero}">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                        <i class="fas fa-vial text-primary me-2"></i>
                        Muestra #<span class="muestra-numero">${numero}</span>
                    </h6>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-muestra">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-square text-info me-1"></i>
                            Área (m²)
                        </label>
                        <input type="number" 
                               class="form-control" 
                               name="muestras[${numero-1}][area_m2]"
                               value="1"
                               step="0.01"
                               min="0.01"
                               required>
                        <div class="form-text">Normalmente 1 m²</div>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-semibold required">
                            <i class="fas fa-leaf text-success me-1"></i>
                            Peso Verde (g)
                            <span class="text-danger">*</span>
                        </label>
                        <input type="number" 
                               class="form-control peso-verde" 
                               name="muestras[${numero-1}][peso_verde_g]"
                               step="0.1"
                               min="0"
                               required>
                        <div class="invalid-feedback">Ingrese el peso verde</div>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-weight text-warning me-1"></i>
                            Peso Seco (g)
                        </label>
                        <input type="number" 
                               class="form-control peso-seco" 
                               name="muestras[${numero-1}][peso_seco_g]"
                               step="0.1"
                               min="0">
                        <div class="form-text">Opcional - después del secado</div>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-calculator text-primary me-1"></i>
                            kg/ha MV
                        </label>
                        <input type="text" 
                               class="form-control bg-light resultado-kgha" 
                               readonly>
                        <div class="form-text">Calculado automáticamente</div>
                    </div>
                </div>
                
                <div class="row g-3 mt-2" style="display: none;" data-resultados>
                    <div class="col-md-4">
                        <div class="bg-light rounded p-2 text-center">
                            <small class="text-muted">kg/ha MS</small>
                            <div class="fw-bold resultado-ms">-</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-light rounded p-2 text-center">
                            <small class="text-muted">% MS</small>
                            <div class="fw-bold resultado-porcentaje">-</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-light rounded p-2 text-center">
                            <small class="text-muted">Calidad</small>
                            <div class="fw-bold resultado-calidad">-</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Update remove buttons visibility
    function updateRemoveButtons() {
        const muestras = document.querySelectorAll('.muestra-item');
        muestras.forEach((muestra, index) => {
            const removeBtn = muestra.querySelector('.remove-muestra');
            removeBtn.style.display = muestras.length > 1 ? 'block' : 'none';
        });
    }
    
    // Remove sample
    function removeMuestra(element) {
        element.closest('.muestra-item').remove();
        updateMuestraNumbers();
        updateRemoveButtons();
        calculateResumen();
    }
    
    // Update sample numbers
    function updateMuestraNumbers() {
        const muestras = document.querySelectorAll('.muestra-item');
        muestras.forEach((muestra, index) => {
            muestra.querySelector('.muestra-numero').textContent = index + 1;
            muestra.dataset.muestra = index + 1;
            
            // Update input names
            const inputs = muestra.querySelectorAll('input[name*="muestras"]');
            inputs.forEach(input => {
                const name = input.name;
                input.name = name.replace(/muestras\[\d+\]/, `muestras[${index}]`);
            });
        });
        muestraCount = muestras.length;
    }
    
    // Calculate individual sample
    function calculateMuestra(muestraElement) {
        const area = parseFloat(muestraElement.querySelector('input[name*="area_m2"]').value) || 1;
        const pesoVerde = parseFloat(muestraElement.querySelector('.peso-verde').value) || 0;
        const pesoSeco = parseFloat(muestraElement.querySelector('.peso-seco').value) || 0;
        
        // Calculate kg/ha MV
        const kgHaMV = (pesoVerde / area) * 10; // Convert g/m² to kg/ha
        muestraElement.querySelector('.resultado-kgha').value = kgHaMV.toFixed(0);
        
        // Calculate additional results if peso seco is available
        const resultadosDiv = muestraElement.querySelector('[data-resultados]');
        if (pesoSeco > 0) {
            const kgHaMS = (pesoSeco / area) * 10;
            const porcentajeMS = (pesoSeco / pesoVerde) * 100;
            
            muestraElement.querySelector('.resultado-ms').textContent = kgHaMS.toFixed(0);
            muestraElement.querySelector('.resultado-porcentaje').textContent = porcentajeMS.toFixed(1) + '%';
            
            // Quality assessment
            let calidad = 'Baja';
            let colorClass = 'text-danger';
            if (kgHaMV >= 2500) {
                calidad = 'Excelente';
                colorClass = 'text-success';
            } else if (kgHaMV >= 2000) {
                calidad = 'Buena';
                colorClass = 'text-primary';
            } else if (kgHaMV >= 1500) {
                calidad = 'Regular';
                colorClass = 'text-warning';
            }
            
            const calidadElement = muestraElement.querySelector('.resultado-calidad');
            calidadElement.textContent = calidad;
            calidadElement.className = `fw-bold ${colorClass}`;
            
            resultadosDiv.style.display = 'block';
        } else {
            resultadosDiv.style.display = 'none';
        }
        
        calculateResumen();
    }
    
    // Calculate overall summary
    function calculateResumen() {
        const muestras = document.querySelectorAll('.muestra-item');
        let totalMV = 0;
        let totalMS = 0;
        let totalPorcentaje = 0;
        let countWithMS = 0;
        let validMuestras = 0;
        
        muestras.forEach(muestra => {
            const pesoVerde = parseFloat(muestra.querySelector('.peso-verde').value) || 0;
            const pesoSeco = parseFloat(muestra.querySelector('.peso-seco').value) || 0;
            const area = parseFloat(muestra.querySelector('input[name*="area_m2"]').value) || 1;
            
            if (pesoVerde > 0) {
                totalMV += (pesoVerde / area) * 10;
                validMuestras++;
                
                if (pesoSeco > 0) {
                    totalMS += (pesoSeco / area) * 10;
                    totalPorcentaje += (pesoSeco / pesoVerde) * 100;
                    countWithMS++;
                }
            }
        });
        
        if (validMuestras > 0) {
            const promedioMV = totalMV / validMuestras;
            document.getElementById('promedio-mv').textContent = promedioMV.toFixed(0);
            
            if (countWithMS > 0) {
                document.getElementById('promedio-ms').textContent = (totalMS / countWithMS).toFixed(0);
                document.getElementById('promedio-porcentaje').textContent = (totalPorcentaje / countWithMS).toFixed(1) + '%';
                
                // Overall quality
                let calidadGeneral = 'Baja';
                let colorClass = 'text-danger';
                if (promedioMV >= 2500) {
                    calidadGeneral = 'Excelente';
                    colorClass = 'text-success';
                } else if (promedioMV >= 2000) {
                    calidadGeneral = 'Buena';
                    colorClass = 'text-primary';
                } else if (promedioMV >= 1500) {
                    calidadGeneral = 'Regular';
                    colorClass = 'text-warning';
                }
                
                const calidadElement = document.getElementById('calidad-general');
                calidadElement.textContent = calidadGeneral;
                calidadElement.className = `fw-bold fs-4 ${colorClass}`;
            }
            
            resumenCard.style.display = 'block';
        } else {
            resumenCard.style.display = 'none';
        }
    }
    
    // Attach events to muestra elements
    function attachMuestraEvents() {
        // Remove button events
        document.querySelectorAll('.remove-muestra').forEach(btn => {
            btn.replaceWith(btn.cloneNode(true)); // Remove old listeners
            btn.addEventListener('click', () => removeMuestra(btn));
        });
        
        // Input events for calculations
        document.querySelectorAll('.peso-verde, .peso-seco, input[name*="area_m2"]').forEach(input => {
            input.addEventListener('input', function() {
                calculateMuestra(this.closest('.muestra-item'));
            });
        });
    }
    
    // Initial setup
    attachMuestraEvents();
    updateRemoveButtons();
    
    // Form validation
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Validate basic fields
        if (!potreroSelect.value) {
            potreroSelect.classList.add('is-invalid');
            isValid = false;
        }
        
        if (!fechaInput.value) {
            fechaInput.classList.add('is-invalid');
            isValid = false;
        }
        
        // Validate at least one sample with peso verde
        const hasValidSample = Array.from(document.querySelectorAll('.peso-verde')).some(input => 
            parseFloat(input.value) > 0
        );
        
        if (!hasValidSample) {
            alert('Debe ingresar al menos una muestra con peso verde.');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        } else {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
            submitBtn.disabled = true;
        }
    });
});
</script>
{% endblock %} 